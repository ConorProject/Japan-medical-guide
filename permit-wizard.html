<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Deploy v3 - Enhanced features -->
    <title>Permit Application Wizard - Japan Medication Guide (Enhanced)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            background: #f8f9fa;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .wizard-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .wizard-step {
            padding: 30px;
            border-bottom: 1px solid #dee2e6;
        }

        .wizard-step:last-child {
            border-bottom: none;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            background: #007bff;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 15px;
        }

        .step-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
        }

        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            width: 100%;
            margin-top: 20px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .generate-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .checklist-item {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checklist-item:hover {
            border-color: #007bff;
        }

        .checklist-item.completed {
            background: #d4edda;
            border-color: #28a745;
        }

        .medication-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.prohibited {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.restricted {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.permitted {
            background: #d4edda;
            color: #155724;
        }

        .permit-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
        }

        .permit-not-required {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .permit-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .permit-required {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .permit-prohibited {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Medication Guide</a>
        
        <div class="header">
            <h1>üìã Permit Application Wizard</h1>
            <p>Generate all required documents for your medication import permit</p>
            
            <div class="privacy-badge" style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; padding: 15px; margin-top: 20px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 20px;">üîí</span>
                <div style="flex: 1; text-align: left;">
                    <strong style="color: #2e7d32;">100% Private & Secure</strong><br>
                    <small style="color: #388e3c;">All your personal information stays on your device. Nothing is sent to our servers.</small>
                </div>
                <a href="privacy.html" target="_blank" style="color: #2e7d32; text-decoration: none; font-size: 12px; border: 1px solid #4caf50; padding: 5px 10px; border-radius: 4px; background: white;">
                    Privacy Policy
                </a>
            </div>
        </div>

        <div id="selectedMedication" class="medication-info">
            <!-- Will be populated by JavaScript -->
        </div>

        <div class="wizard-card">
            <div class="wizard-step">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Medication Quantity</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tablet Strength (mg per tablet)</label>
                    <input type="number" class="form-control" id="strength" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Number of Tablets</label>
                    <input type="number" class="form-control" id="tabletCount" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Trip Duration (days)</label>
                    <input type="number" class="form-control" id="tripDays" required>
                </div>
                
                <div id="quantityCalculation" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <div class="wizard-step">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Travel Information</div>
                </div>
                
                <div class="privacy-explanation" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 25px;">
                    <h4 style="margin: 0 0 10px 0; color: #495057; display: flex; align-items: center; gap: 8px;">
                        <span>üîí</span> Your Privacy is Protected
                    </h4>
                    <p style="margin: 0 0 15px 0; font-size: 14px; line-height: 1.5; color: #6c757d;">
                        <strong>All information you enter stays completely private:</strong>
                    </p>
                    <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #6c757d;">
                        <li><strong>Local processing:</strong> All forms and documents are generated in your browser</li>
                        <li><strong>No data collection:</strong> We don't store, track, or transmit your personal information</li>
                        <li><strong>No accounts required:</strong> No registration, no passwords, no data profiles</li>
                        <li><strong>You control sharing:</strong> Only you decide what to send to Japanese authorities</li>
                    </ul>
                    <p style="margin: 15px 0 0 0; font-size: 13px; color: #868e96;">
                        <em>This wizard works entirely offline after the page loads. Your medical and travel details never leave your device.</em>
                    </p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Full Name (as on passport)</label>
                    <input type="text" class="form-control" id="fullName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Arrival Date in Japan</label>
                    <input type="date" class="form-control" id="arrivalDate" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Entry Port</label>
                    <select class="form-control" id="entryPort" required>
                        <option value="">Select your arrival airport</option>
                        <option value="NRT">Narita International Airport (NRT)</option>
                        <option value="HND">Tokyo Haneda Airport (HND)</option>
                        <option value="KIX">Kansai International Airport (KIX)</option>
                        <option value="NGO">Chubu Centrair International Airport (NGO)</option>
                        <option value="CTS">New Chitose Airport (CTS)</option>
                        <option value="FUK">Fukuoka Airport (FUK)</option>
                    </select>
                </div>
            </div>

            <div class="wizard-step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Document Checklist</div>
                </div>
                
                <div class="checklist-item" onclick="toggleChecklist(this)">
                    <strong>‚úì Passport copy ready</strong><br>
                    <small>Photo page showing your name and passport number</small>
                </div>
                
                <div class="checklist-item" onclick="toggleChecklist(this)">
                    <strong>‚úì Prescription copy ready</strong><br>
                    <small>Clear photo or scan of your current prescription</small>
                </div>
                
                <div class="checklist-item" onclick="toggleChecklist(this)">
                    <strong>‚úì Flight booking confirmation</strong><br>
                    <small>Showing your arrival date and entry port</small>
                </div>
                
                <div class="checklist-item" onclick="toggleChecklist(this)">
                    <strong>‚úì Hotel/accommodation booking</strong><br>
                    <small>Confirmation of where you'll be staying</small>
                </div>
                
                <div class="checklist-item" onclick="toggleChecklist(this)">
                    <strong>‚úì Doctor available for letter</strong><br>
                    <small>Confirmed your doctor can provide the required medical letter</small>
                </div>
            </div>

            <div class="wizard-step">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div class="step-title">Generate Documents</div>
                </div>
                
                <p>Once all information is complete and documents are ready, generate your permit application package:</p>
                
                <div class="privacy-reminder" style="background: #e3f2fd; border: 1px solid #90caf9; border-radius: 6px; padding: 15px; margin: 15px 0; font-size: 14px;">
                    <strong style="color: #1565c0;">üîí Privacy Note:</strong> 
                    <span style="color: #1976d2;">Documents are generated locally in your browser. Your personal information is not transmitted to our servers during this process.</span>
                </div>
                
                <button class="generate-btn" onclick="generateDocuments()">
                    Generate My Documents ‚Üí
                </button>
            </div>
        </div>
    </div>

    <script>
        let wizardData = {};

        // Function to find the correct threshold entry based on quantity
        function findCorrectThresholdEntry(medicationName, userQuantityMg) {
            try {
                const allMedicationsData = sessionStorage.getItem('allMedicationsData');
                if (!allMedicationsData) {
                    // Data not ready yet, return current medication as fallback
                    return wizardData.medication;
                }
                
                const allMedications = JSON.parse(allMedicationsData);
                const medicationRows = allMedications.filter(med => 
                    med.name.toLowerCase().includes(medicationName.toLowerCase()) ||
                    med.genericName.toLowerCase().includes(medicationName.toLowerCase())
                );
                
                if (medicationRows.length === 0) {
                    return wizardData.medication; // fallback to original
                }
                
                // Find the correct threshold row based on quantity and description matching
                // Special case: if threshold is 0, always requires permit regardless of quantity
                const zeroThresholdRow = medicationRows.find(row => row.thresholdNumeric === 0);
            if (zeroThresholdRow) {
                return zeroThresholdRow;
            }
            
            // Find the appropriate threshold row based on user quantity
            for (const row of medicationRows) {
                const threshold = row.thresholdNumeric;
                const description = row.thresholdDescription.toLowerCase();
                
                // Check if this row's description matches the user's quantity situation
                if (description.includes('up to') || description.includes('below') || description.includes('under') || description.includes('within')) {
                    // This is the "under/at threshold" row
                    if (userQuantityMg <= threshold) {
                        return row;
                    }
                } else if (description.includes('more than') || description.includes('above') || description.includes('exceeds') || description.includes('over')) {
                    // This is the "over threshold" row  
                    if (userQuantityMg > threshold) {
                        return row;
                    }
                } else if (description.includes('exactly') || description.includes('equal')) {
                    // Handle exact match cases
                    if (userQuantityMg === threshold) {
                        return row;
                    }
                }
            }
            
            // Fallback: find the most appropriate row based on quantity range
            const thresholds = [...new Set(medicationRows.map(row => row.thresholdNumeric))];
            const maxThreshold = Math.max(...thresholds);
            
            if (userQuantityMg <= maxThreshold) {
                // Look for an "up to" row
                const upToRow = medicationRows.find(row => {
                    const desc = row.thresholdDescription.toLowerCase();
                    return desc.includes('up to') || desc.includes('below') || desc.includes('under');
                });
                if (upToRow) return upToRow;
            } else {
                // Look for a "more than" row
                const moreThanRow = medicationRows.find(row => {
                    const desc = row.thresholdDescription.toLowerCase();
                    return desc.includes('more than') || desc.includes('above') || desc.includes('over');
                });
                if (moreThanRow) return moreThanRow;
            }
            
                return medicationRows[0];
                
            } catch (error) {
                console.error('Error in findCorrectThresholdEntry:', error);
                return wizardData.medication; // fallback on any error
            }
        }

        // Load medication from sessionStorage (enhanced with CSV data)
        document.addEventListener('DOMContentLoaded', function() {
            const storedMedication = sessionStorage.getItem('permitMedicationData');
            if (storedMedication) {
                try {
                    const medication = JSON.parse(storedMedication);
                    wizardData.medication = medication;
                    
                    // Auto-populate form with pre-calculated data
                    if (medication.preCalculated) {
                        const calc = medication.preCalculated;
                        
                        setTimeout(() => {
                            const strengthInput = document.getElementById('strength');
                            const tabletsInput = document.getElementById('tabletCount');
                            const daysInput = document.getElementById('tripDays');
                            
                            // Pre-populate form fields
                            if (strengthInput && calc.strengthMg) strengthInput.value = calc.strengthMg;
                            if (tabletsInput && calc.tablets) tabletsInput.value = calc.tablets;
                            if (daysInput && calc.days) daysInput.value = calc.days;
                            
                            // Auto-calculate with pre-filled values
                            setTimeout(() => {
                                if (strengthInput?.value && tabletsInput?.value && daysInput?.value) {
                                    calculateQuantity();
                                }
                            }, 200);
                        }, 100);
                    }
                    
                    // Enhanced medication display with CSV data - find permit processing time
                    const allMedications = JSON.parse(sessionStorage.getItem('allMedicationsData') || '[]');
                    const permitEntry = allMedications.find(med => 
                        (med.name.toLowerCase() === medication.name.toLowerCase() || 
                         med.genericName.toLowerCase() === medication.genericName.toLowerCase()) &&
                        med.processingDaysMin > 0
                    );
                    const permitProcessingTime = permitEntry ? 
                        `${permitEntry.processingDaysMin}-${permitEntry.processingDaysMax} days` : 
                        'Varies by case';
                    
                    document.getElementById('selectedMedication').innerHTML = `
                        <h3>Selected Medication: ${medication.name}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                            <div>
                                <p><strong>Generic Name:</strong> ${medication.genericName}</p>
                                <p><strong>Category:</strong> ${medication.category}</p>
                                <p><strong>Status:</strong> <span class="status-badge ${medication.status}">${medication.status.toUpperCase()}</span></p>
                            </div>
                            <div>
                                <p><strong>Threshold:</strong> ${medication.thresholdNumeric / 1000}g</p>
                                <p><strong>Processing Time:</strong> ${permitProcessingTime}</p>
                                ${medication.officialSource ? `<p><strong>Source:</strong> <a href="${medication.officialSource}" target="_blank">Official Documentation</a></p>` : ''}
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('Error parsing medication data:', error);
                    showNoMedicationError();
                }
            } else {
                showNoMedicationError();
            }
            
            function showNoMedicationError() {
                document.getElementById('selectedMedication').innerHTML = `
                    <h3>‚ö†Ô∏è No medication selected</h3>
                    <p><a href="index.html">Return to medication guide</a> and select a medication first.</p>
                    <p><small>Make sure to click the "üìã Permit Application" button from a medication card.</small></p>
                `;
            }

            // Add event listeners for calculations
            document.getElementById('strength').addEventListener('input', calculateQuantity);
            document.getElementById('tabletCount').addEventListener('input', calculateQuantity);
            document.getElementById('tripDays').addEventListener('input', calculateQuantity);
        });

        function updateCalculations() {
            calculateQuantity();
        }

        // Replace the existing calculateQuantity function with this improved version
        function calculateQuantity() {
            const strength = parseFloat(document.getElementById('strength').value);
            const tabletCount = parseInt(document.getElementById('tabletCount').value);
            const tripDays = parseInt(document.getElementById('tripDays').value);

            if (!strength || !tabletCount || !tripDays) {
                return;
            }

            const totalMg = strength * tabletCount * tripDays;
            const dailyDose = tabletCount / tripDays;

            wizardData.quantity = {
                strength,
                tabletCount,
                tripDays,
                totalMg,
                dailyDose
            };

            // Find the correct threshold entry based on calculated quantity
            const correctMedication = findCorrectThresholdEntry(wizardData.medication.name, totalMg);
            const thresholdNumeric = correctMedication ? correctMedication.thresholdNumeric : null;
            const medicationStatus = correctMedication ? correctMedication.status : null;
            const percentageOfLimit = thresholdNumeric && thresholdNumeric > 0 ? (totalMg / thresholdNumeric * 100) : 0;
            
            // Determine permit requirement using CSV data
            let permitStatus, recommendation, nextAction;
            
            // Use actual medication status from CSV
            if (medicationStatus === 'prohibited') {
                permitStatus = 'prohibited';
                recommendation = 'This medication is prohibited in Japan and cannot be imported';
                nextAction = 'show-alternatives';
            } else if (medicationStatus === 'permitted' && (!thresholdNumeric || thresholdNumeric === 0 || totalMg <= thresholdNumeric)) {
                // Under limit for permitted medication
                permitStatus = 'no-permit-needed';
                recommendation = 'No permit required - within personal use limits';
                nextAction = 'travel-letter';
            } else if (thresholdNumeric === 0 || medicationStatus === 'restricted') {
                // Always requires permit OR is restricted status
                permitStatus = 'permit-required';
                recommendation = wizardData.medication.actionRequired || 'This medication requires an import permit';
                nextAction = 'continue-application';
            } else if (percentageOfLimit <= 50) {
                // Well under limit
                permitStatus = 'well-under';
                recommendation = 'You\'re well under the limit. No permit needed!';
                nextAction = 'travel-letter';
            } else if (percentageOfLimit <= 90) {
                // Getting close
                permitStatus = 'getting-close';
                recommendation = 'You\'re approaching the limit. Consider preparing documents as backup.';
                nextAction = 'optional-documents';
            } else if (percentageOfLimit < 100) {
                // Very close
                permitStatus = 'very-close';
                recommendation = 'You\'re very close to the limit! We strongly recommend preparing permit documents.';
                nextAction = 'recommended-documents';
            } else {
                // Over limit
                permitStatus = 'over-limit';
                recommendation = 'You exceed Japan\'s limit. A permit is required.';
                nextAction = 'continue-application';
            }

            wizardData.permitRequired = (percentageOfLimit >= 100 || thresholdNumeric === 0);
            wizardData.percentageOfLimit = percentageOfLimit;

            // Update the medication card with correct threshold info
            if (correctMedication) {
                updateMedicationCard(correctMedication);
            }

            // Display enhanced results
            displayQuantityResults(permitStatus, recommendation, nextAction, percentageOfLimit);
        }

        function displayQuantityResults(permitStatus, recommendation, nextAction, percentageOfLimit) {
            const resultDiv = document.getElementById('quantityCalculation');
            const thresholdNumeric = wizardData.medication ? wizardData.medication.thresholdNumeric : null;
            const thresholdDescription = wizardData.medication ? wizardData.medication.thresholdDescription : null;
            
            let resultHTML = `
                <div class="result-header">Calculation Results</div>
                <div class="result-item">
                    <span class="result-label">Total amount:</span>
                    <span class="result-value">${wizardData.quantity.totalMg}mg (${wizardData.quantity.tabletCount} tablets)</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Daily average:</span>
                    <span class="result-value">${wizardData.quantity.dailyDose.toFixed(1)} tablets</span>
                </div>
            `;

            if (thresholdNumeric !== null && thresholdNumeric !== undefined) {
                resultHTML += `
                    <div class="result-item">
                        <span class="result-label">Japan's limit:</span>
                        <span class="result-value">${thresholdNumeric === 0 ? 'No exemption (Always requires permit)' : thresholdNumeric + 'mg'}</span>
                    </div>
                `;
                
                // Show descriptive threshold from CSV
                if (thresholdDescription) {
                    resultHTML += `
                        <div class="result-item">
                            <span class="result-label">Threshold details:</span>
                            <span class="result-value">${thresholdDescription}</span>
                        </div>
                    `;
                }

                if (thresholdNumeric > 0) {
                    // Add visual progress bar
                    resultHTML += `
                        <div style="margin: 20px 0;">
                            <div style="background: #e9ecef; height: 30px; border-radius: 15px; overflow: hidden; position: relative;">
                                <div style="background: ${getProgressColor(percentageOfLimit)}; width: ${Math.min(percentageOfLimit, 100)}%; height: 100%; transition: width 0.5s ease;">
                                </div>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold;">
                                    ${percentageOfLimit.toFixed(0)}% of limit
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // Add status-specific styling and message
            const statusStyles = {
                'no-permit-needed': 'permit-not-required',
                'well-under': 'permit-not-required', 
                'getting-close': 'permit-warning',
                'very-close': 'permit-warning',
                'over-limit': 'permit-required',
                'permit-required': 'permit-required',
                'prohibited': 'permit-prohibited'
            };

            resultHTML += `
                <div class="permit-status ${statusStyles[permitStatus]}">
                    ${getStatusIcon(permitStatus)} ${recommendation}
                </div>
            `;

            resultDiv.innerHTML = resultHTML;
        }

        function updateMedicationCard(correctMedication) {
            // Update wizardData.medication so other functions use the correct threshold data
            if (correctMedication) {
                wizardData.medication = correctMedication;
            }
        }

        function getProgressColor(percentage) {
            if (percentage <= 50) return '#28a745';
            if (percentage <= 90) return '#ffc107';
            return '#dc3545';
        }

        function getStatusIcon(status) {
            const icons = {
                'no-permit-needed': '‚úÖ',
                'well-under': '‚úÖ',
                'getting-close': '‚ö†Ô∏è',
                'very-close': 'üü°',
                'over-limit': 'üìã',
                'permit-required': 'üìã',
                'prohibited': 'üö´',
                'show-alternatives': 'üö´'
            };
            return icons[status] || 'üìã';
        }

        function generateTravelLetter() {
            // Simple travel letter for under-limit medications
            const letterHTML = `
                <div style="max-width: 600px; margin: 30px auto; padding: 30px; background: #f8f9fa; border-radius: 10px;">
                    <h3>‚úàÔ∏è Travel Letter Generated!</h3>
                    <p>Even though you don't need a permit, it's good to have documentation.</p>
                    
                    <div style="background: white; padding: 20px; border-radius: 5px; margin: 20px 0;">
                        <strong>To Whom It May Concern:</strong><br><br>
                        This letter confirms that the bearer is carrying ${wizardData.medication ? wizardData.medication.name : 'medication'} 
                        (${wizardData.quantity.tabletCount} tablets, ${wizardData.quantity.totalMg}mg total) 
                        for personal medical use during their ${wizardData.quantity.tripDays}-day trip to Japan.<br><br>
                        This quantity is within Japan's personal use allowance and does not require an import permit.<br><br>
                        Date: ${new Date().toLocaleDateString()}
                    </div>
                    
                    <button class="btn btn-primary" onclick="window.print()">Print Letter</button>
                    <button class="btn btn-secondary" onclick="location.reload()">Start Over</button>
                </div>
            `;
            
            const step2Div = document.getElementById('step2');
            if (step2Div) {
                step2Div.innerHTML = letterHTML;
            }
        }

        function showWhyTravelLetter() {
            alert('Even when no permit is required, a travel letter can:\n\n' +
                  '‚Ä¢ Speed up customs checks\n' +
                  '‚Ä¢ Avoid language barriers\n' +
                  '‚Ä¢ Provide peace of mind\n' +
                  '‚Ä¢ Document your medical needs\n\n' +
                  'It takes just seconds to generate!');
        }

        function toggleChecklist(item) {
            item.classList.toggle('completed');
        }

        function collectFormData() {
            // Collect travel info
            wizardData.travelInfo = {
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                arrivalDate: document.getElementById('arrivalDate').value,
                entryPort: document.getElementById('entryPort').value
            };

            // Add bureau info based on entry port
            const bureauMap = {
                'NRT': { name: 'Kanto-Shin\'etsu', email: 'tokyoncd@mhlw.go.jp' },
                'HND': { name: 'Kanto-Shin\'etsu', email: 'tokyoncd@mhlw.go.jp' },
                'KIX': { name: 'Kinki', email: 'osakancd@mhlw.go.jp' },
                'NGO': { name: 'Kinki', email: 'osakancd@mhlw.go.jp' },
                'CTS': { name: 'Hokkaido', email: 'sapporoncd@mhlw.go.jp' },
                'FUK': { name: 'Kyushu', email: 'fukuokancd@mhlw.go.jp' }
            };
            
            wizardData.travelInfo.bureau = bureauMap[wizardData.travelInfo.entryPort] || bureauMap['NRT'];
        }

        // Document Generation Functions
        function generateDocuments() {
            if (!allDocumentsChecked()) {
                alert('Please check all document requirements first');
                return;
            }

            // Collect form data
            collectFormData();

            // Show loading state
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Generating documents...';

            // Generate all documents
            setTimeout(() => {
                generateYunyuKakuninsho();
                generateDoctorLetter();
                generateEmailTemplate();
                showDownloadModal();
                
                btn.disabled = false;
                btn.textContent = 'Generate My Documents ‚Üí';
            }, 1000);
        }

        function allDocumentsChecked() {
            const checkedItems = document.querySelectorAll('.checklist-item.completed');
            return checkedItems.length === 5;
        }

        // Generate Yunyu Kakunin-sho Form
        function generateYunyuKakuninsho() {
            const formHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Yunyu Kakunin-sho Application - ${wizardData.travelInfo.fullName}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .form-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #000;
        }
        .form-title-jp {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .form-title-en {
            font-size: 18px;
            color: #333;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }
        .form-row {
            display: flex;
            margin-bottom: 15px;
            align-items: center;
        }
        .form-label {
            min-width: 200px;
            font-weight: bold;
        }
        .form-value {
            flex: 1;
            padding: 8px;
            background: white;
            border: 1px solid #ccc;
            min-height: 30px;
        }
        .medication-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .medication-table th,
        .medication-table td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        .medication-table th {
            background: #e9e9e9;
            font-weight: bold;
        }
        .notes {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
        }
        @media print {
            body { margin: 0; padding: 10px; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="form-header">
        <div class="form-title-jp">Ëñ¨Áõ£Ë®ºÊòéÁî≥Ë´ãÊõ∏</div>
        <div class="form-title-en">YUNYU KAKUNIN-SHO (Import Confirmation) Application</div>
    </div>

    <div class="section">
        <div class="section-title">Áî≥Ë´ãËÄÖÊÉÖÂ†± / Applicant Information</div>
        <div class="form-row">
            <div class="form-label">Ê∞èÂêç / Full Name:</div>
            <div class="form-value">${wizardData.travelInfo.fullName}</div>
        </div>
        <div class="form-row">
            <div class="form-label">Email:</div>
            <div class="form-value">${wizardData.travelInfo.email}</div>
        </div>
        <div class="form-row">
            <div class="form-label">ÂÖ•ÂõΩ‰∫àÂÆöÊó• / Entry Date:</div>
            <div class="form-value">${formatJapaneseDate(wizardData.travelInfo.arrivalDate)}</div>
        </div>
        <div class="form-row">
            <div class="form-label">ÂÖ•ÂõΩÂú∞ / Port of Entry:</div>
            <div class="form-value">${getAirportName(wizardData.travelInfo.entryPort)}</div>
        </div>
        <div class="form-row">
            <div class="form-label">ÊªûÂú®ÊúüÈñì / Duration:</div>
            <div class="form-value">${wizardData.quantity.tripDays} days</div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">ÂåªËñ¨ÂìÅÊÉÖÂ†± / Medication Information</div>
        <table class="medication-table">
            <thead>
                <tr>
                    <th>ÂåªËñ¨ÂìÅÂêç<br>Medication Name</th>
                    <th>ÊàêÂàÜÂêç<br>Generic Name</th>
                    <th>Âê´ÊúâÈáè<br>Strength</th>
                    <th>Êï∞Èáè<br>Quantity</th>
                    <th>Á∑èÈáè<br>Total Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>${wizardData.medication.name}</td>
                    <td>${wizardData.medication.genericName}</td>
                    <td>${wizardData.quantity.strength}mg</td>
                    <td>${wizardData.quantity.tabletCount} tablets</td>
                    <td>${wizardData.quantity.totalMg}mg</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <div class="section-title">ÊèêÂá∫ÂÖà / Submission Bureau</div>
        <div class="form-row">
            <div class="form-label">Âú∞ÊñπÂéöÁîüÂ±Ä / Regional Bureau:</div>
            <div class="form-value">${wizardData.travelInfo.bureau.name} Regional Bureau of Health and Welfare</div>
        </div>
        <div class="form-row">
            <div class="form-label">Email:</div>
            <div class="form-value">${wizardData.travelInfo.bureau.email}</div>
        </div>
    </div>

    <div class="notes">
        <strong>Important Notes:</strong>
        <ul>
            <li>This form has been pre-filled based on your information</li>
            <li>Print this form and sign it before scanning</li>
            <li>Submit along with other required documents</li>
            <li>Processing time: ${wizardData.medication.processingDaysMin > 0 ? 
                `${wizardData.medication.processingDaysMin}-${wizardData.medication.processingDaysMax} business days` : 
                'varies by case'}</li>
            ${wizardData.medication.officialSource ? 
                `<li><strong>Reference:</strong> Based on <a href="${wizardData.medication.officialSource}" target="_blank">official MHLW guidance</a></li>` : ''}
        </ul>
    </div>

    <div class="no-print" style="margin-top: 30px; text-align: center;">
        <button onclick="window.print()" style="padding: 10px 30px; font-size: 16px;">Print This Form</button>
    </div>
</body>
</html>
            `;
            
            // Store for download
            window.generatedDocuments = window.generatedDocuments || {};
            window.generatedDocuments.yunyuForm = formHTML;
        }

        // Generate Doctor's Letter Template
        function generateDoctorLetter() {
            const letterHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Doctor's Letter - ${wizardData.travelInfo.fullName}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 700px;
            margin: 0 auto;
            padding: 40px;
            line-height: 1.8;
        }
        .letterhead {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #333;
        }
        .letterhead-placeholder {
            background: #f0f0f0;
            padding: 40px;
            border: 2px dashed #999;
            color: #666;
            margin-bottom: 20px;
        }
        .date {
            text-align: right;
            margin-bottom: 30px;
        }
        .recipient {
            margin-bottom: 30px;
        }
        .medication-details {
            background: #f9f9f9;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .japanese-section {
            background: #f0f8ff;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #b0d4ff;
        }
        .signature-area {
            margin-top: 60px;
        }
        .signature-line {
            border-bottom: 1px solid #333;
            width: 300px;
            margin-top: 60px;
        }
        @media print {
            .no-print { display: none; }
            body { margin: 0; padding: 20px; }
        }

        .permit-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .permit-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
        }

        /* Progress bar styles */
        .limit-progress-bar {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin: 20px 0;
        }

        .limit-progress-fill {
            height: 100%;
            transition: width 0.5s ease;
        }

        .limit-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: #333;
        }

        .permit-not-required {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .permit-required {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .result-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .result-label {
            font-weight: 500;
        }

        .result-value {
            font-weight: 600;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="letterhead">
        <div class="letterhead-placeholder">
            [YOUR DOCTOR'S LETTERHEAD HERE]<br>
            Clinic/Hospital Name<br>
            Address<br>
            Phone | Fax | Email
        </div>
    </div>

    <div class="date">${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>

    <div class="recipient">
        <strong>To: Regional Bureau of Health and Welfare</strong><br>
        Ministry of Health, Labour and Welfare<br>
        Government of Japan
    </div>

    <p><strong>RE: Medical Certificate for ${wizardData.travelInfo.fullName}</strong></p>

    <p>To Whom It May Concern:</p>

    <p>I am writing to certify that my patient, <strong>${wizardData.travelInfo.fullName}</strong>, 
    requires the following medication for their medical condition during their travel to Japan 
    from ${formatDisplayDate(wizardData.travelInfo.arrivalDate)} for ${wizardData.quantity.tripDays} days.</p>

    <div class="medication-details">
        <strong>Prescribed Medication:</strong><br>
        Medication: ${wizardData.medication.name}<br>
        Generic Name: ${wizardData.medication.genericName}<br>
        Category: ${wizardData.medication.category}<br>
        Dosage: ${wizardData.quantity.strength}mg per tablet<br>
        Quantity: ${wizardData.quantity.tabletCount} tablets<br>
        Total Amount: ${wizardData.quantity.totalMg}mg<br>
        Daily Dose: Approximately ${wizardData.quantity.dailyDose.toFixed(1)} tablets per day<br>
        Classification: ${wizardData.medication.status.charAt(0).toUpperCase() + wizardData.medication.status.slice(1)} medication
    </div>

    <p>This medication is medically necessary for the patient's health and well-being. The quantity 
    prescribed represents a ${wizardData.quantity.tripDays}-day supply for personal use only during their stay in Japan.</p>

    <p>The patient has been under my care since [DATE], and has been stable on this medication regimen. 
    Discontinuation of this medication could result in serious health consequences.</p>

    <div class="japanese-section">
        <strong>Êó•Êú¨Ë™ûË¶ÅÁ¥Ñ / Japanese Summary:</strong><br>
        ÊÇ£ËÄÖÂêç: ${wizardData.travelInfo.fullName}<br>
        Ëñ¨ÂìÅÂêç: ${wizardData.medication.name}<br>
        ‰∏ÄËà¨Âêç: ${wizardData.medication.genericName}<br>
        Âá¶ÊñπÈáè: ${wizardData.quantity.totalMg}mg (${wizardData.quantity.tabletCount}Èå†)<br>
        ‰ΩøÁî®ÁõÆÁöÑ: ÂÄã‰∫∫‰ΩøÁî®„ÄÅÂåªÁôÇ‰∏äÂøÖË¶Å<br>
        ÊªûÂú®ÊúüÈñì: ${wizardData.quantity.tripDays}Êó•Èñì<br>
        ÂàÜÈ°û: ${wizardData.medication.status === 'restricted' ? 'Âà∂ÈôêËñ¨Áâ©' : 
              wizardData.medication.status === 'permitted' ? 'Ë®±ÂèØËñ¨Áâ©' : 'Ëñ¨Áâ©'}
    </div>

    <p>This medical assessment is consistent with current Japanese import regulations. 
    ${wizardData.medication.reasonForClassification ? 
        `Classification rationale: ${wizardData.medication.reasonForClassification}` : ''}</p>

    ${wizardData.medication.officialSource ? 
        `<p style="font-size: 12px; color: #666; margin-top: 20px;"><strong>Reference:</strong> 
        This letter follows guidelines from the Japanese Ministry of Health, Labour and Welfare. 
        <a href="${wizardData.medication.officialSource}" target="_blank">View official source</a></p>` : ''}

    <p>Should you require any additional information, please do not hesitate to contact me at the above address.</p>

    <p>Sincerely,</p>

    <div class="signature-area">
        <div class="signature-line"></div>
        <p>
            [Doctor's Name], [Degree]<br>
            [License Number]<br>
            [Contact Information]
        </p>
    </div>

    <div class="no-print" style="margin-top: 40px; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7;">
        <strong>Instructions for your doctor:</strong>
        <ol>
            <li>Print this letter on official letterhead</li>
            <li>Fill in the bracketed information</li>
            <li>Sign and stamp (if applicable)</li>
            <li>Provide original to patient</li>
        </ol>
    </div>
</body>
</html>
            `;
            
            window.generatedDocuments.doctorLetter = letterHTML;
        }

        // Generate Email Template
        function generateEmailTemplate() {
            const emailTemplate = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Email Template - Permit Submission</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .email-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .email-header {
            background: #007bff;
            color: white;
            padding: 20px;
            margin: -30px -30px 30px -30px;
            border-radius: 10px 10px 0 0;
        }
        .field {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        .field-label {
            font-weight: bold;
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .field-value {
            font-family: monospace;
            white-space: pre-wrap;
        }
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            float: right;
        }
        .copy-btn:hover {
            background: #218838;
        }
        .japanese-text {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .attachments {
            background: #fff3cd;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="email-container">
        <div class="email-header">
            <h2 style="margin: 0;">Email Template for Permit Submission</h2>
            <p style="margin: 5px 0 0 0; opacity: 0.9;">To: ${wizardData.travelInfo.bureau.name} Regional Bureau</p>
        </div>

        <div class="field">
            <button class="copy-btn" onclick="copyToClipboard('email-to')">Copy</button>
            <div class="field-label">TO:</div>
            <div class="field-value" id="email-to">${wizardData.travelInfo.bureau.email}</div>
        </div>

        <div class="field">
            <button class="copy-btn" onclick="copyToClipboard('email-subject')">Copy</button>
            <div class="field-label">SUBJECT:</div>
            <div class="field-value" id="email-subject">Ëñ¨Áõ£Ë®ºÊòéÁî≥Ë´ã / Yunyu Kakunin-sho Application - ${wizardData.travelInfo.fullName}</div>
        </div>

        <div class="field">
            <button class="copy-btn" onclick="copyToClipboard('email-body')">Copy All</button>
            <div class="field-label">EMAIL BODY:</div>
            <div class="field-value" id="email-body">${wizardData.travelInfo.bureau.name}Âú∞ÊñπÂéöÁîüÂ±Ä Âæ°‰∏≠
To the ${wizardData.travelInfo.bureau.name} Regional Bureau of Health and Welfare,

ÁßÅ„ÅØ${formatDisplayDate(wizardData.travelInfo.arrivalDate)}„Å´Êó•Êú¨„Å´ÂÖ•ÂõΩ‰∫àÂÆö„ÅÆ${wizardData.travelInfo.fullName}„Å®Áî≥„Åó„Åæ„Åô„ÄÇ
ÂÄã‰∫∫‰ΩøÁî®„ÅÆ„Åü„ÇÅ„ÅÆÂåªËñ¨ÂìÅ„ÅÆËº∏ÂÖ•Á¢∫Ë™ç„ÇíÁî≥Ë´ã„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ

I am ${wizardData.travelInfo.fullName}, planning to enter Japan on ${formatDisplayDate(wizardData.travelInfo.arrivalDate)}.
I would like to apply for import confirmation for my personal medication.

Áî≥Ë´ãÂÜÖÂÆπ / Application Details:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
ÂÖ•ÂõΩÊó• / Entry Date: ${formatDisplayDate(wizardData.travelInfo.arrivalDate)}
ÂÖ•ÂõΩÂú∞ / Port of Entry: ${getAirportName(wizardData.travelInfo.entryPort)}
ÊªûÂú®ÊúüÈñì / Duration of Stay: ${wizardData.quantity.tripDays} days

ÂåªËñ¨ÂìÅÊÉÖÂ†± / Medication Information:
Ëñ¨ÂìÅÂêç / Medication Name: ${wizardData.medication.name}
‰∏ÄËà¨Âêç / Generic Name: ${wizardData.medication.genericName}
ÂàÜÈ°û / Category: ${wizardData.medication.category}
Êï∞Èáè / Quantity: ${wizardData.quantity.tabletCount} tablets (${wizardData.quantity.totalMg}mg)
‰ΩøÁî®ÁõÆÁöÑ / Purpose: ÂÄã‰∫∫‰ΩøÁî® / Personal medical use
Áä∂ÊÖã / Status: ${wizardData.medication.status.charAt(0).toUpperCase() + wizardData.medication.status.slice(1)}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Ê∑ª‰ªòÊõ∏È°û / Attached Documents:
1. Ëñ¨Áõ£Ë®ºÊòéÁî≥Ë´ãÊõ∏ / Yunyu Kakunin-sho Application Form
2. ÂåªÂ∏´„ÅÆË®ºÊòéÊõ∏ / Doctor's Certificate  
3. Âá¶ÊñπÁÆã„ÅÆÂÜô„Åó / Copy of Prescription
4. „Éë„Çπ„Éù„Éº„Éà„ÅÆÂÜô„Åó / Copy of Passport
5. ÊóÖÁ®ãË°® / Travel Itinerary

„ÅîÂØ©Êüª„ÅÆ„Åª„Å©„ÄÅ„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ
Thank you for your consideration of this application.

Êï¨ÂÖ∑ / Sincerely,
${wizardData.travelInfo.fullName}
${wizardData.travelInfo.email}</div>
        </div>

        <div class="attachments">
            <strong>üìé Attachment Checklist:</strong>
            <ul style="margin: 10px 0;">
                <li>‚úì Yunyu Kakunin-sho form (PDF)</li>
                <li>‚úì Doctor's letter (PDF)</li>
                <li>‚úì Prescription copy (JPG/PDF)</li>
                <li>‚úì Passport photo page (JPG/PDF)</li>
                <li>‚úì Flight/hotel bookings (PDF)</li>
            </ul>
            <p style="margin-bottom: 0; font-size: 14px;">
                <strong>File naming suggestion:</strong> 
                ${wizardData.travelInfo.fullName.replace(/\s+/g, '_')}_[DocumentType].pdf
            </p>
        </div>

        <div style="margin-top: 20px; padding: 20px; background: #d4edda; border-radius: 5px;">
            <strong>‚úÖ Next Steps:</strong>
            <ol style="margin: 10px 0;">
                <li>Copy the email content above</li>
                <li>Attach all required documents</li>
                <li>Send to the bureau email address</li>
                <li>You should receive an auto-reply within 24-48 hours</li>
                <li>Full processing takes 14-21 business days</li>
            </ol>
        </div>
    </div>

    <script>
        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            });
        }
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
            `;
            
            window.generatedDocuments.emailTemplate = emailTemplate;
        }

        // Helper functions
        function formatJapaneseDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${year}Âπ¥${month}Êúà${day}Êó•`;
        }

        function formatDisplayDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function getAirportName(code) {
            const airports = {
                'NRT': 'Narita International Airport',
                'HND': 'Tokyo Haneda Airport',
                'KIX': 'Kansai International Airport',
                'NGO': 'Chubu Centrair International Airport',
                'CTS': 'New Chitose Airport',
                'FUK': 'Fukuoka Airport'
            };
            return airports[code] || code;
        }

        // Show download modal
        function showDownloadModal() {
            // Remove any existing modal first
            const existingModal = document.getElementById('downloadModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modalHTML = `
                <div id="downloadModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;" onclick="if(event.target.id === 'downloadModal') closeDownloadModal()">
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation();">
                        <h2 style="margin-top: 0;">üìÑ Your Documents Are Ready!</h2>
                        <p>Click each document to open in a new tab. Save or print as needed.</p>
                        
                        <div style="margin: 20px 0;">
                            <button onclick="openDocument('yunyuForm')" style="width: 100%; padding: 15px; margin-bottom: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                üìã Open Yunyu Kakunin-sho Form
                            </button>
                            <button onclick="openDocument('doctorLetter')" style="width: 100%; padding: 15px; margin-bottom: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                üë®‚Äç‚öïÔ∏è Open Doctor's Letter Template
                            </button>
                            <button onclick="openDocument('emailTemplate')" style="width: 100%; padding: 15px; margin-bottom: 10px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                ‚úâÔ∏è Open Email Template
                            </button>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
                            <strong>üí° Quick Tips:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>Save all documents as PDFs</li>
                                <li>Keep file sizes under 10MB total</li>
                                <li>Name files clearly (e.g., "John_Smith_YunyuForm.pdf")</li>
                            </ul>
                        </div>
                        
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 20px 0; font-size: 13px; text-align: center;">
                            <strong style="color: #2e7d32;">üîí Your documents contain your personal information.</strong><br>
                            <span style="color: #388e3c;">Only share them with Japanese authorities or trusted medical professionals.</span>
                        </div>
                        
                        <button onclick="closeDownloadModal()" style="width: 100%; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function openDocument(docType) {
            const doc = window.generatedDocuments[docType];
            const newWindow = window.open('', '_blank');
            newWindow.document.write(doc);
            newWindow.document.close();
        }

        function closeDownloadModal() {
            const modal = document.getElementById('downloadModal');
            if (modal) {
                modal.style.display = 'none';
                setTimeout(() => {
                    modal.remove();
                }, 100);
            }
        }

        function goToStep3() {
            // Only validate if we have quantity data
            if (!wizardData.quantity.totalMg) {
                alert('Please calculate your quantity first');
                return;
            }
            
            // Check if we actually need their info
            if (wizardData.permitRequired || wizardData.percentageOfLimit > 50) {
                showStep(3);
            } else {
                // Skip to simple letter generation
                generateTravelLetter();
            }
        }

        function showStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.style.display = 'none';
            });
            
            // Show the requested step
            const targetStep = document.getElementById('step' + stepNumber);
            if (targetStep) {
                targetStep.style.display = 'block';
            }
        }
    </script>
</body>
</html>
